# Data Explanation for Margin Line Automation

This document outlines the structure and contents of the dataset used for training the Deep Learning model to automate dental margin line detection.

## 1. Dataset Overview
The dataset consists of patient case folders. Each folder represents a single dental restoration case (e.g., a crown or bridge) and contains:
- **3D Scans (.stl)**: Raw input data from the dental scanner.
- **Design Metadata (.xml)**: "Ground truth" labels generated by the human designer using Exocad.

Two sample cases are currently available:
- `lamyaa_ratmi_2026-01-22_Dt malek`
- `steven_mourad_2026-01-22_Dt mersal`

## 2. Directory Structure & Key Files
A typical case folder contains the following critical files:

```text
[Case Name]/
├── [Case Name]-UpperJaw.stl          <-- INPUT: The raw scan of the prep arch (Scanner Space)
├── [Case Name]-LowerJaw.stl          <-- INPUT (Antagonist): The opposing jaw scan (Scanner Space)
├── [Case Name].constructionInfo      <-- LABELS & ALIGNMENT: Contains Margin lines and ZRotationMatrix
├── [Case Name].dentalProject         <-- METADATA: Project details and file links
└── [Case Name]-...-waxup...stl       <-- OPTIONAL: Designed tooth anatomy (Design Space)
```

## 3. Detailed File Analysis

### A. `*.constructionInfo` (The "Ground Truth" File)
This XML file is the most critical for training. It contains both the target output (margins) and the transformation needed to align inputs.

#### **1. The Margin Line (Target Label)**
*   **Path**: `<ConstructionInfo> / <Teeth> / <Tooth> / <Margin>`
*   **Data**: A list of `Vec3` points `{x, y, z}` defining the closed loop of the margin curve.
*   **Coordinate Space**: **Design Space** (Local coordinate system of the designed tooth).

```xml
<Margin>
  <Vec3>
    <x>6.787...</x>
    <y>7.161...</y>
    <z>1.302...</z>
  </Vec3>
  ...
</Margin>
```

#### **2. The Alignment Matrix**
*   **Path**: `<ConstructionInfo> / <Teeth> / <Tooth> / <ZRotationMatrix>`
*   **Data**: A 4x4 homogenous transformation matrix flattened into keys `_00` through `_33`.
*   **Purpose**: Transforms the **Scanner Mesh** (UpperJaw.stl) into **Design Space** (where the Margin exists).
*   **CRITICAL NOTE**: As noted in `alignment_issue_prompt.md`, this matrix uses a **Row-Vector Convention**.
    *   **Translation** corresponds to `_30` (x), `_31` (y), `_32` (z).
    *   **Action**: You must **Transpose** this matrix before applying it in standard Python/standard libraries (which expect Column-Vector convention).

```xml
<ZRotationMatrix>
  <_00>-0.960...</_00>
  ...
  <_30>5.540...</_30>  <-- Translation X
  <_31>-0.723...</_31> <-- Translation Y
  <_32>7.343...</_32>  <-- Translation Z
</ZRotationMatrix>
```

### B. `*.dentalProject` (Metadata)
Use this file to dynamically find the correct `.stl` file names associated with the case.

*   **Scan Links**: Under `<ScanFiles>`, it links a `PartName` (e.g., "Jaw scan") to a `FileName` (e.g., `...-UpperJaw.stl`).
*   **Project Info**: `<PatientId>`, `<PracticeId>`, and timestamps.

### C. `*-UpperJaw.stl` and `*-LowerJaw.stl` (The Input Meshes)
*   **UpperJaw.stl**: High-resolution 3D mesh of the patient's upper jaw, including the prepared tooth stub. This is the **primary input** for margin detection.
*   **LowerJaw.stl**: The opposing jaw (antagonist). Important for context (occlusion), though not the primary target for margin lines in single-arch prep cases. It typically shares the same **Scanner Space** coordinate system as the UpperJaw.
*   **Coordinate Space**: **Scanner Space**.
*   **Preprocessing**: To create valid `{Input, Label}` pairs for training, the *UpperJaw* mesh must be transformed using the transposed `ZRotationMatrix` so it aligns with the `Margin` coordinates. If the LowerJaw is needed in Design Space spatial context, the same matrix should likely be applied (subject to specific case requirements).